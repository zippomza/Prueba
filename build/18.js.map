{"version":3,"sources":["../../src/core/settings/pages/space-usage/space-usage.module.ts","../../src/core/settings/pages/space-usage/space-usage.ts"],"names":[],"mappings":"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","file":"18.js","sourcesContent":["// (C) Copyright 2015 Martin Dougiamas\r\n//\r\n// Licensed under the Apache License, Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//     http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n\r\nimport { NgModule } from '@angular/core';\r\nimport { IonicPageModule } from 'ionic-angular';\r\nimport { TranslateModule } from '@ngx-translate/core';\r\nimport { CoreSettingsSpaceUsagePage } from './space-usage';\r\nimport { CoreComponentsModule } from '@components/components.module';\r\nimport { CoreDirectivesModule } from '@directives/directives.module';\r\nimport { CorePipesModule } from '@pipes/pipes.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        CoreSettingsSpaceUsagePage\r\n    ],\r\n    imports: [\r\n        CoreComponentsModule,\r\n        CoreDirectivesModule,\r\n        CorePipesModule,\r\n        IonicPageModule.forChild(CoreSettingsSpaceUsagePage),\r\n        TranslateModule.forChild()\r\n    ],\r\n})\r\nexport class CoreSettingsSpaceUsagePageModule {}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/core/settings/pages/space-usage/space-usage.module.ts","// (C) Copyright 2015 Martin Dougiamas\r\n//\r\n// Licensed under the Apache License, Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//     http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n\r\nimport { Component, } from '@angular/core';\r\nimport { IonicPage } from 'ionic-angular';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { CoreAppProvider } from '@providers/app';\r\nimport { CoreFileProvider } from '@providers/file';\r\nimport { CoreFilepoolProvider } from '@providers/filepool';\r\nimport { CoreSitesProvider } from '@providers/sites';\r\nimport { CoreTextUtilsProvider } from '@providers/utils/text';\r\nimport { CoreDomUtilsProvider } from '@providers/utils/dom';\r\n\r\n/**\r\n * Page that displays the space usage settings.\r\n */\r\n@IonicPage({segment: 'core-settings-space-usage'})\r\n@Component({\r\n    selector: 'page-core-settings-space-usage',\r\n    templateUrl: 'space-usage.html',\r\n})\r\nexport class CoreSettingsSpaceUsagePage {\r\n\r\n    usageLoaded = false;\r\n    sites = [];\r\n    currentSiteId = '';\r\n    totalUsage = 0;\r\n    freeSpace = 0;\r\n    showFreeSpace = true;\r\n\r\n    constructor(private fileProvider: CoreFileProvider, private filePoolProvider: CoreFilepoolProvider,\r\n            private sitesProvider: CoreSitesProvider, private textUtils: CoreTextUtilsProvider,\r\n            private translate: TranslateService, private domUtils: CoreDomUtilsProvider, appProvider: CoreAppProvider) {\r\n        this.currentSiteId = this.sitesProvider.getCurrentSiteId();\r\n        this.showFreeSpace = !appProvider.isDesktop();\r\n    }\r\n\r\n    /**\r\n     * View loaded.\r\n     */\r\n    ionViewDidLoad(): void {\r\n        this.fetchData().finally(() => {\r\n            this.usageLoaded = true;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Convenience function to calculate each site's usage, and the total usage.\r\n     *\r\n     * @return {Promise<any>} Resolved when done.\r\n     */\r\n    protected calculateSizeUsage(): Promise<any> {\r\n        return this.sitesProvider.getSortedSites().then((sites) => {\r\n            this.sites = sites;\r\n\r\n            // Get space usage.\r\n            const promises = this.sites.map((siteEntry) => {\r\n                return this.sitesProvider.getSite(siteEntry.id).then((site) => {\r\n                    return site.getSpaceUsage().then((size) => {\r\n                        siteEntry.spaceUsage = size;\r\n                    });\r\n                });\r\n            });\r\n\r\n            return Promise.all(promises);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Convenience function to calculate total usage.\r\n     */\r\n    protected calculateTotalUsage(): void {\r\n        let total = 0;\r\n        this.sites.forEach((site) => {\r\n            if (site.spaceUsage) {\r\n                total += parseInt(site.spaceUsage, 10);\r\n            }\r\n        });\r\n        this.totalUsage = total;\r\n    }\r\n\r\n    /**\r\n     * Convenience function to calculate free space in the device.\r\n     *\r\n     * @return {Promise<any>} Resolved when done.\r\n     */\r\n    protected calculateFreeSpace(): Promise<any> {\r\n        if (this.fileProvider.isAvailable()) {\r\n            return this.fileProvider.calculateFreeSpace().then((freeSpace) => {\r\n                this.freeSpace = freeSpace;\r\n            }).catch(() => {\r\n                this.freeSpace = 0;\r\n            });\r\n        } else {\r\n            this.freeSpace = 0;\r\n\r\n            return Promise.resolve(null);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Convenience function to calculate space usage and free space in the device.\r\n     *\r\n     * @return {Promise<any>} Resolved when done.\r\n     */\r\n    protected fetchData(): Promise<any> {\r\n        const promises = [\r\n            this.calculateSizeUsage().then(() => this.calculateTotalUsage()),\r\n        ];\r\n\r\n        if (this.showFreeSpace) {\r\n            promises.push(this.calculateFreeSpace());\r\n        }\r\n\r\n        return Promise.all(promises);\r\n    }\r\n\r\n    /**\r\n     * Refresh the data.\r\n     *\r\n     * @param {any} refresher Refresher.\r\n     */\r\n    refreshData(refresher: any): void {\r\n        this.fetchData().finally(() => {\r\n            refresher.complete();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Convenience function to update site size, along with total usage and free space.\r\n     *\r\n     * @param {any} site Site object with space usage.\r\n     * @param {number} newUsage New space usage of the site in bytes.\r\n     */\r\n    protected updateSiteUsage(site: any, newUsage: number): void {\r\n        const oldUsage = site.spaceUsage;\r\n        site.spaceUsage = newUsage;\r\n        this.totalUsage -= oldUsage - newUsage;\r\n        this.freeSpace += oldUsage - newUsage;\r\n    }\r\n\r\n    /**\r\n     * Deletes files of a site.\r\n     *\r\n     * @param {any} siteData Site object with space usage.\r\n     */\r\n    deleteSiteFiles(siteData: any): void {\r\n        this.textUtils.formatText(siteData.siteName).then((siteName) => {\r\n            const title = this.translate.instant('core.settings.deletesitefilestitle');\r\n            const message = this.translate.instant('core.settings.deletesitefiles', {sitename: siteName});\r\n\r\n            this.domUtils.showConfirm(message, title).then(() => {\r\n                return this.sitesProvider.getSite(siteData.id);\r\n            }).then((site) => {\r\n                site.deleteFolder().then(() => {\r\n                    this.filePoolProvider.clearAllPackagesStatus(site.id);\r\n                    this.filePoolProvider.clearFilepool(site.id);\r\n                    this.updateSiteUsage(siteData, 0);\r\n                }).catch((error) => {\r\n                    if (error && error.code === FileError.NOT_FOUND_ERR) {\r\n                        // Not found, set size 0.\r\n                        this.filePoolProvider.clearAllPackagesStatus(site.id);\r\n                        this.updateSiteUsage(siteData, 0);\r\n                    } else {\r\n                        // Error, recalculate the site usage.\r\n                        this.domUtils.showErrorModal('core.settings.errordeletesitefiles', true);\r\n                        site.getSpaceUsage().then((size) => {\r\n                            this.updateSiteUsage(siteData, size);\r\n                        });\r\n                    }\r\n                });\r\n            }).catch(() => {\r\n                // Ignore cancelled confirmation modal.\r\n            });\r\n        });\r\n    }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/core/settings/pages/space-usage/space-usage.ts"],"sourceRoot":""}